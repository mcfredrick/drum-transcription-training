# Hierarchical Drum Transcription Model Configuration
# 5-branch architecture with shared encoder

# Dataset paths (on HDD for large data)
data:
  egmd_root: "/mnt/hdd/drum-tranxn/e-gmd-v1.0.0"  # Raw E-GMD dataset
  processed_root: "/mnt/hdd/drum-tranxn/processed_data_hierarchical"  # Preprocessed with 12-class (including crash)
  splits_dir: "/mnt/hdd/drum-tranxn/processed_data_hierarchical/splits"  # Train/val/test split files
  train_split: 0.7
  val_split: 0.15
  test_split: 0.15
  random_seed: 42
  use_hdf5: true  # Use HDF5 format for faster loading

# Audio preprocessing (matches preprocessed data)
audio:
  sample_rate: 22050
  n_fft: 2048
  hop_length: 512  # ~23ms frames (43 FPS)
  n_mels: 128
  fmin: 30  # Hz - captures kick fundamentals (20-100 Hz range)
  fmax: 11025  # Nyquist frequency - captures cymbals (up to 8 kHz focus)

# Hierarchical model architecture
model:
  name: "HierarchicalDrumCRNN"
  n_mels: 128

  # Shared CNN encoder
  conv_filters: [32, 64, 128, 256]  # 4 blocks
  conv_kernel_size: 3
  pool_size: 2  # Pool in frequency only, not time
  dropout_cnn: 0.25

  # Shared LSTM encoder
  hidden_size: 256  # Will be 512 after bidirectional
  num_lstm_layers: 2
  dropout_lstm: 0.3

  # Branch weights for loss computation
  branch_weights:
    kick: 1.5            # High priority - critical for rhythm game
    snare: 1.5           # High priority - critical for rhythm game
    tom_primary: 1.0     # Medium priority - important for fills
    tom_variation: 0.7   # Lower priority - conditional
    cymbal_primary: 1.2  # High priority - rhythm keeping
    hihat_variation: 0.5 # Lower priority - conditional, nice to have
    ride_variation: 0.5  # Lower priority - conditional, nice to have
    crash: 0.6           # Medium-low priority - rare events, accent detector

# Training hyperparameters
training:
  batch_size: 2  # Minimal batch size for RTX 3070 memory constraints
  num_epochs: 100
  learning_rate: 0.001  # Standard learning rate
  weight_decay: 0.0001
  optimizer: "AdamW"
  scheduler: "ReduceLROnPlateau"
  scheduler_patience: 10
  scheduler_factor: 0.5
  gradient_clip_val: 1.0
  precision: "16-mixed"  # Mixed precision training for speed
  accumulate_grad_batches: 8  # Effective batch size = 2 * 8 = 16

# Data augmentation
augmentation:
  enabled: true
  time_stretch_prob: 0.5
  time_stretch_range: [0.9, 1.1]
  pitch_shift_prob: 0.5
  pitch_shift_range: [-2, 2]  # semitones
  volume_scale_prob: 0.5
  volume_scale_range: [-6, 6]  # dB
  reverb_prob: 0.3
  reverb_delay_range: [1, 3]  # frames
  reverb_attenuation_range: [0.2, 0.4]
  noise_prob: 0.3
  noise_level_range: [0.01, 0.05]

# Early stopping
early_stopping:
  enabled: true
  monitor: "val_loss"
  patience: 20  # More patience for hierarchical model
  mode: "min"
  min_delta: 0.001

# Checkpointing (saved to HDD)
checkpoint:
  monitor: "val_kick_roc_auc"  # Monitor kick ROC-AUC (primary metric)
  save_top_k: 3
  mode: "max"
  save_last: true
  dirpath: "/mnt/hdd/drum-tranxn/checkpoints/hierarchical"
  filename: "hierarchical-{epoch:02d}-{val_kick_roc_auc:.3f}"

# Logging (saved to HDD)
logging:
  logger: "tensorboard"
  project_name: "drum-transcription-hierarchical"
  experiment_name: "hierarchical-5branch-shared-encoder"
  log_every_n_steps: 10
  save_dir: "/mnt/hdd/drum-tranxn/logs/hierarchical"

# Hardware
hardware:
  devices: [0]  # GPU IDs to use (single RTX 3070)
  num_workers: 4  # Data loader workers per GPU
  accelerator: "gpu"

# Evaluation thresholds (for inference, not training)
# During training, we use threshold-independent metrics (ROC-AUC, PR-AUC)
postprocessing:
  # Initial thresholds (will be optimized per-branch after training)
  kick_threshold: 0.5
  snare_threshold: 0.5
  tom_threshold: 0.5
  cymbal_threshold: 0.5
  crash_threshold: 0.6  # Higher threshold for crash (prioritize precision)

  # Onset detection parameters
  min_onset_interval: 0.05  # Minimum time between onsets (seconds)
  peak_min_distance: 2  # Minimum distance between peaks (frames)

# Success criteria (targets)
targets:
  # Tier 1 (Critical - minimum viable)
  kick_recall_min: 0.75
  kick_precision_min: 0.70
  snare_recall_min: 0.75
  snare_precision_min: 0.70

  # Tier 1 (Target performance)
  kick_recall_target: 0.85
  kick_precision_target: 0.75
  snare_recall_target: 0.85
  snare_precision_target: 0.75

  # AUC targets (threshold-independent)
  kick_roc_auc_target: 0.85
  snare_roc_auc_target: 0.85
  tom_roc_auc_target: 0.80
  cymbal_roc_auc_target: 0.82
  crash_roc_auc_target: 0.75  # Lower target (rare class, hard problem)
