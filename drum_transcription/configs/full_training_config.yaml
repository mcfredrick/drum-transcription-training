# Full training configuration for drum transcription pipeline - Standard Drum Kit (11-Class)
# This uses ALL files and optimized hyperparameters from Optuna study

data:
  # E-GMD dataset paths (on HDD)
  egmd_root: "/mnt/hdd/drum-tranxn/e-gmd-v1.0.0"
  processed_root: "/mnt/hdd/drum-tranxn/processed_data"
  splits_dir: "/mnt/hdd/drum-tranxn/processed_data/splits"

  # Full training - use all files
  max_files: null

  # Train/val/test split ratios
  train_split: 0.7
  val_split: 0.15
  test_split: 0.15
  random_seed: 42

# Audio preprocessing (same as test config)
audio:
  sample_rate: 22050
  n_fft: 2048
  hop_length: 512
  n_mels: 128
  fmin: 30
  fmax: 11025

model:
  # CRNN architecture - Standard drum kit (11 classes)
  name: "DrumTranscriptionCRNN"
  n_mels: 128
  n_classes: 11  # 11 standard drum kit classes (0-10)

  # CNN parameters
  conv_filters: [64, 128, 256]  # Reduced from [32, 64, 128, 256] - fewer classes need less capacity
  conv_kernel_size: 3
  pool_size: 2
  dropout_cnn: 0.25  # Reduced dropout for smaller model

  # RNN parameters
  hidden_size: 128  # Reduced from 256 - fewer classes need less capacity
  num_gru_layers: 3
  dropout_gru: 0.3  # Reduced dropout
  bidirectional: true

training:
  # Full training settings - Will be updated with Optuna-optimized hyperparameters for 11-class system
  num_epochs: 100  # Reduced from 150 - simpler task converges faster
  batch_size: 4  # Reduced for 7.65GB GPU memory
  learning_rate: 0.001  # Standard learning rate - will be optimized by Optuna
  optimizer: AdamW  # AdamW for better generalization
  weight_decay: 0.0001  # Standard weight decay - will be optimized by Optuna
  scheduler: "ReduceLROnPlateau"
  scheduler_patience: 10  # Reduced patience - faster convergence expected
  scheduler_factor: 0.5

  # Optimization
  gradient_clip_val: 1.0
  accumulate_grad_batches: 1  # No accumulation needed with larger batches
  precision: "16-mixed"  # Mixed precision for faster training

augmentation:
  enabled: true  # Enable augmentation for better generalization
  time_stretch_prob: 0.5
  time_stretch_range: [0.9, 1.1]
  pitch_shift_prob: 0.5
  pitch_shift_range: [-2, 2]  # semitones
  volume_scale_prob: 0.5
  volume_scale_range: [-6, 6]  # dB
  reverb_prob: 0.3
  reverb_delay_range: [1, 3]  # frames
  reverb_attenuation_range: [0.2, 0.4]
  noise_prob: 0.3
  noise_level_range: [0.01, 0.05]
  
# Loss function
loss:
  type: "BCELoss"
  class_weights: [0.5, 0.5, 1.5, 3.5, 0.8, 0.9, 15.0, 1.5, 1.6, 1.0, 13.0]  # Weights for 11 classes (inverse frequency)

# Early stopping - optimized for full training
early_stopping:
  enabled: true
  monitor: "val_loss"
  patience: 20  # Reduced from 25 - faster convergence expected
  mode: "min"
  min_delta: 0.0005

# Checkpointing
checkpoint:
  monitor: "val_loss"
  save_top_k: 5  # Save top 5 checkpoints
  mode: "min"
  save_last: true  # Always save last checkpoint for resuming
  dirpath: "/mnt/hdd/drum-tranxn/checkpoints"
  filename: "drum-11class-full-training-{epoch:02d}-{val_loss:.4f}"

# Logging
logging:
  logger: "tensorboard"
  project_name: "drum-transcription-11class-full"
  experiment_name: "11class-full-training-100epoch-optuna-optimized"
  log_every_n_steps: 10
  save_dir: "/mnt/hdd/drum-tranxn/logs"

# Hardware
hardware:
  devices: [0]  # Single GPU (3070) for test
  num_workers: 4  # More workers than quick test
  accelerator: "gpu"
  
postprocessing:
  # Onset detection thresholds
  onset_threshold: 0.5
  min_onset_interval: 0.05  # 50ms minimum between onsets
  peak_min_distance: 2

# Standard drum kit mapping (11 classes)
drum_midi:
  drum_names: [
    "kick", "snare_head", "snare_rim", "side_stick",
    "hihat_pedal", "hihat_closed", "hihat_open",
    "floor_tom", "high_mid_tom",
    "ride", "ride_bell"
  ]
  midi_to_class:
    36: 0   # Kick
    38: 1   # Snare head
    40: 2   # Snare rim
    37: 3   # Side stick
    44: 4   # Pedal hi-hat
    42: 5   # Closed hi-hat
    46: 6   # Open hi-hat
    43: 7   # Floor tom
    48: 8   # High-mid tom
    51: 9   # Ride
    53: 10  # Ride bell

  class_to_midi:
    0: 36   # Kick
    1: 38   # Snare head
    2: 40   # Snare rim
    3: 37   # Side stick
    4: 44   # Pedal hi-hat
    5: 42   # Closed hi-hat
    6: 46   # Open hi-hat
    7: 43   # Floor tom
    8: 48   # High-mid tom
    9: 51   # Ride
    10: 53  # Ride bell

  default_velocity: 80
  note_duration_ticks: 50
